<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lead Devotion: REPL Experiments #2</title>
    
<meta name="keywords" content="clojure,datomic,java,repl,jsf">

<meta name="description" content="Apr√®s avoir explor√© les possiblit√©s du REPL sur un programme Clojure en cours d&#39;ex√©cution (ici) Nous allons voir comment &quot;brancher&quot; Clojure sur une application Java.Une des inspirations pour cette exp√©rience est le tweet suivant.">

<meta property="og:description" content="Apr√®s avoir explor√© les possiblit√©s du REPL sur un programme Clojure en cours d&#39;ex√©cution (ici) Nous allons voir comment &quot;brancher&quot; Clojure sur une application Java.Une des inspirations pour cette exp√©rience est le tweet suivant.">

<meta property="og:url" content="https://charlynux.github.io/posts-output/2020-11-29-repl-experiments-2/" />
<meta property="og:title" content="REPL Experiments #2" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://charlynux.github.io/posts-output/2020-11-29-repl-experiments-2/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
    />
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css"
    />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#navbar"
            aria-expanded="false"
            aria-controls="navbar"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Lead Devotion</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li >
              <a href="/">Home</a>
            </li>
            <li >
              <a href="/archives/">Archives</a>
            </li>
            
            <li><a href="/feed.xml">RSS</a></li>
          </ul>
        </div>
        <!--/.nav-collapse -->
      </div>
      <!--/.container-fluid -->
    </nav>

    <div class="container">
      <div class="row">
        <div class="col-lg-9">
          <div id="content">
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">November 29, 2020</div>
        
    </div>
    <h2>REPL Experiments #2</h2>
</div>
<div>
    
    <p>Apr√®s avoir explor√© les possiblit√©s du REPL sur un programme Clojure en cours d'ex√©cution (<a href="/posts/2020-11-28-repl-experiments-first.md">ici</a>) Nous allons voir comment "brancher" Clojure sur une application Java.</p><p>Une des inspirations pour cette exp√©rience est le tweet suivant.</p><blockquote class="twitter-tweet" data-conversation="none"><p lang="en" dir="ltr">üíØ I have a talk proposal floating around about saving literally person-years of labor by inserting an NREPL server into a terrible legacy Java system so I could live code it.</p>‚Äî ‚∏òJack Rusher‚ÄΩ (@jackrusher) <a href="https://twitter.com/jackrusher/status/1263877097933754370?ref_src=twsrc%5Etfw">May 22, 2020</a></blockquote> <script async="async" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2 id="lapplication">L'application</h2><p>Je n'avais de "terrible legacy Java system" sous la main. Je me suis donc rabattu sur une petite application en JSF (technologie que je ne connais pas) √©crite par un enseignant pour ses √©l√®ves de Licence 2.</p><p>Elle g√®re des √©tudiants (les utilisateurs) et leurs notes.</p><h2 id="honn√™tet√©-intellectuelle">Honn√™tet√© intellectuelle</h2><p>Ce post pourrait laisser croire que cet exercice a √©t√© facile. Il n'en est rien. J'ai suivi plusieurs fausses pistes. Puis j'ai r√©ussi √† lancer un serveur NREPL dans l'application. Enfin apr√®s quelques simplications, je suis parvenu √† lancer un Socket REPL (sans autre d√©pendance que Clojure) et √† choisir (via un profile Maven) quand cette configuration est inclus ou non.</p><h2 id="mode-op√©ratoire">Mode op√©ratoire</h2><h3 id="clojure">Clojure</h3><p>Avant toute chose, il nous faut ajouter la d√©pendance Clojure. S'agissant d'un projet Maven, on ajoute les lignes dans le pom.xml.</p><pre><code class="maven-pom">&lt;dependency&gt;
    &lt;groupId&gt;org.clojure&lt;/groupId&gt;
    &lt;artifactId&gt;clojure&lt;/artifactId&gt;
    &lt;version&gt;1.10.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h3 id="lancer-le-repl">Lancer le REPL</h3><p>Je ne suis pas parvenu √† lancer le REPL via les arguments. Je me suis donc rabattu sur une solution en Java.</p><p>Cette solution est d√©tourn√©e d'un snippet en <a href="https://blog.michielborkent.nl/2016/07/26/clojure-from-scala/">Scala</a> et ressemble beaucoup √† la m√©thode pour lancer un <a href="https://nrepl.org/nrepl/usage/server.html#embedding-in-a-java-application">NREPL</a>.</p><pre><code class="java">IFn require = Clojure.var("clojure.core", "require");
require.invoke(Clojure.read("clojure.core.server"));
IFn start = Clojure.var("clojure.core.server", "start-server");
start.invoke(Clojure.read("{:port 5555 :accept clojure.core.server/repl :name repl :server-daemon false}"));
System.out.println("Clojure REPL server started on port 5555");
</code></pre><h3 id="int√©grer-du-code-au-d√©marrage-de-lapplication">Int√©grer du code au d√©marrage de l'application</h3><p>Le code ci-dessus doit √™tre ex√©cut√© au d√©marrage de l'application.</p><p>La solution, qui m'a sembl√© la plus appropri√©e, a √©t√© de m'appuyer sur un "ManagedBean". Ce sont des objets instanci√©s par JSF, en pla√ßant le code dans le constructeur, on lancera le REPL au d√©marrage de l'application.</p><pre><code class="java">import clojure.java.api.Clojure;
import clojure.lang.IFn;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ApplicationScoped;

@ManagedBean(name="clojure-repl", eager=true)
@ApplicationScoped
public class ClojureRepl {
    public ClojureRepl() {
         // Code ci-dessus
    }
}
</code></pre><p><code>@ApplicationScoped</code> indique que l'objet est instanti√© pour la dur√©e de vie de l'application.</p><p><code>eager=true</code> assure que l'objet est instanti√© sans attendre d'√™tre demand√© par quelqu'un.</p><h3 id="conditionner-le-d√©marrage-du-repl">Conditionner le d√©marrage du REPL</h3><p>La technique la plus simple que j'ai trouv√©e consiste √† ajoute √† la demande un dossier contenant ma ClojureRepl.java √† la compilation.</p><pre><code class="maven-pom">&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;clojure-repl&lt;/id&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.clojure&lt;/groupId&gt;
                &lt;artifactId&gt;clojure&lt;/artifactId&gt;
                &lt;version&gt;1.10.1&lt;/version&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
        &lt;build&gt;
            &lt;plugins&gt;
                &lt;plugin&gt;
                    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
                    &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
                    &lt;version&gt;3.2.0&lt;/version&gt;
                    &lt;executions&gt;
                        &lt;execution&gt;
                            &lt;phase&gt;generate-sources&lt;/phase&gt;
                            &lt;goals&gt;
                                &lt;goal&gt;add-source&lt;/goal&gt;
                            &lt;/goals&gt;
                            &lt;configuration&gt;
                                &lt;sources&gt;
                                    &lt;source&gt;src/local/java&lt;/source&gt;
                                &lt;/sources&gt;
                            &lt;/configuration&gt;
                        &lt;/execution&gt;
                    &lt;/executions&gt;
                &lt;/plugin&gt;
            &lt;/plugins&gt;
        &lt;/build&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;
</code></pre><p>Je peux donc d√©marrer le projet avec la commande suivante :</p><pre><code class="cmd">mvn -P clojure-repl jetty:run
</code></pre><h2 id="utilisons-ce-repl">Utilisons ce REPL</h2><p>Je ne suis pas parvenu au niveau de Jash Rusher et √† "live coder" directement l'application.</p><p>La classe UtilisateurJPA est un <a href="https://en.wikipedia.org/wiki/Singleton_pattern">Singleton</a>, qui stocke les utilisateurs dans une liste.</p><p>L'utilisateur poss√®de une m√©thode <code>getMoyenne</code> qui calcule et retourne sa moyenne.</p><pre><code class="clojure">(import '[the.package.jpa UtilisateurJPA])
(import '[the.package.modele Utilisateur])

;; Un utilisateur qui a toujours 20 de moyenne.
(def superuser (proxy [Utilisateur] []
                 (getMoyenne [] (double 20))))

(def me (doto superuser
          (.setLogin "charles")
          (.setMotDePasse "test")))

;; Ajout de cet utilisateur
(.create (UtilisateurJPA.) superuser)
</code></pre><p>Apr√®s cet ajout, je peux m'authentifier avec charles/test et on m'affiche bien une moyenne de 20.</p><h2 id="conclusion">Conclusion</h2><p>Je n'ai pas pu aller aussi loin que j'aurais voulu et "live cod√©" l'application. Mais j'ai quand m√™me pu manipuler l'application d√©ploy√©e.</p><p>J'ajouterais que maintenant j'ai une meilleure vision de ce qu'implique d'ajouter un REPL √† une application Java.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/clojure/">clojure</a>
    
    <a href="/tags-output/java/">java</a>
    
    <a href="/tags-output/repl/">repl</a>
    
    <a href="/tags-output/jsf/">jsf</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts-output/2020-12-18-follow-the-rabbit-datomic/">&laquo; Follow the white rabbit in Datomic</a>
        
        
        <a class="right" href="/posts-output/2020-11-28-repl-experiments-first/">REPL Experiments #1 &raquo;</a>
        
    </div>

    


</div>
</div>
        </div>

        <div class="col-md-3">
          <div id="sidebar">
            
            <div id="recent">
              <h3>Recent Posts</h3>
              <ul>
                
                <li><a href="/posts-output/2020-12-18-follow-the-rabbit-datomic/">Follow the white rabbit in Datomic</a></li>
                
                <li><a href="/posts-output/2020-11-29-repl-experiments-2/">REPL Experiments #2</a></li>
                
                <li><a href="/posts-output/2020-11-28-repl-experiments-first/">REPL Experiments #1</a></li>
                
              </ul>
            </div>
             
            <div id="tags">
              <h3>Tags</h3>
              <ul>
                
                <li><a href="/tags-output/clojure/">clojure</a></li>
                
                <li><a href="/tags-output/datomic/">datomic</a></li>
                
                <li><a href="/tags-output/java/">java</a></li>
                
                <li><a href="/tags-output/repl/">repl</a></li>
                
                <li><a href="/tags-output/jsf/">jsf</a></li>
                
              </ul>
            </div>
            
          </div>
        </div>
      </div>
      <footer>
        Copyright &copy; 2020 Charles Fourdrignier
        <p style="text-align: center">
          Powered by <a href="http://cryogenweb.org">Cryogen</a>
        </p>
      </footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="/js/highlight.pack.js" type="application/javascript"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
     
  </body>
</html>
