<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lead Devotion: Follow the white rabbit in Datomic</title>
    
<meta name="keywords" content="clojure,datomic,java,repl,jsf">

<meta name="description" content="Après le Meetup autour de Datomic, j&#39;ai eu envie d&#39;explorer les capacités d&#39;analyse autour des transactions.Une requête ratée">

<meta property="og:description" content="Après le Meetup autour de Datomic, j&#39;ai eu envie d&#39;explorer les capacités d&#39;analyse autour des transactions.Une requête ratée">

<meta property="og:url" content="https://charlynux.github.io/posts-output/2020-12-18-follow-the-rabbit-datomic/" />
<meta property="og:title" content="Follow the white rabbit in Datomic" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://charlynux.github.io/posts-output/2020-12-18-follow-the-rabbit-datomic/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"
    />
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css"
    />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button
            type="button"
            class="navbar-toggle collapsed"
            data-toggle="collapse"
            data-target="#navbar"
            aria-expanded="false"
            aria-controls="navbar"
          >
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Lead Devotion</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li >
              <a href="/">Home</a>
            </li>
            <li >
              <a href="/archives/">Archives</a>
            </li>
            
            <li><a href="/feed.xml">RSS</a></li>
          </ul>
        </div>
        <!--/.nav-collapse -->
      </div>
      <!--/.container-fluid -->
    </nav>

    <div class="container">
      <div class="row">
        <div class="col-lg-9">
          <div id="content">
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">December 18, 2020</div>
        
    </div>
    <h2>Follow the white rabbit in Datomic</h2>
</div>
<div>
    
    <p>Après le <a href="https://github.com/Charlynux/meetup-crafters-datalog">Meetup</a> autour de Datomic, j'ai eu envie d'explorer les capacités d'analyse autour des transactions.</p><h1 id="une-requête-ratée">Une requête ratée</h1><p>Je voulais connaître toutes les modifications apportées par une transaction. De prime abord, ça ressemble à une requête assez simple. Voici ce à quoi je suis arrivé.</p><pre><code class="clojure">(d/q '[:find ?attr ?value
       :where
       [_  ?a ?value ?tx]
       [?a :db/ident ?attr]]
     (d/db conn)
     interesting-tx)
</code></pre><p>Cette requête échoue pour la raison suivante <code>Insufficent bindings, will cause db scan</code>. Datomic s'appuie sur de nombreux <a href="https://docs.datomic.com/on-prem/indexes.html">index</a> (par entité, par attribut, ...) mais aucun par transaction.</p><h1 id="log-api">Log API</h1><p>Après quelques recherches, je suis tombé sur la <a href="https://docs.datomic.com/on-prem/log.html">Log API</a>. On y trouve une requête qui ressemble à ce que je recherche.</p><pre><code class="clojure">(d/q '[:find ?e
       :in $ ?log ?t1 ?t2
       :where [(tx-ids ?log ?t1 ?t2) [?tx ...]]
              [(tx-data ?log ?tx) [[?e]]]]
     (d/db conn) (d/log conn) #inst "2013-08-01" #inst "2013-08-02")
</code></pre><p>Cette requête cherche toutes les entités modifiées entre deux dates.</p><p>Mais lorsque j'essaie de l'utiliser, j'obtiens une erreur m'indiquant que la fonction <code>log</code> n'existe pas.</p><p>C'est parce que dans mon cas, le <code>d</code> représente <code>datomic.client.api</code> or dans l'exemple il représente <code>datomic.api</code>.</p><h1 id="un-peu-darchitecture">Un peu d'architecture</h1><p>C'est à ce moment que le titre de cet article s'explique. Pour comprendre cette nuance dans les namespaces, il va falloir commencer à regarder l'architecture de Datomic. Ci-dessous, vous trouverez une illustration tirée de la <a href="https://docs.datomic.com/on-prem/architecture.html">documentation officielle</a>.</p><p><img src="https://docs.datomic.com/on-prem/clientarch_orig.png" alt="Datomic Architecture" /></p><p>Nous allons nous concentrer sur ce qui nous intéresse aujourd'hui. La librairie que nous utilisons aujourd'hui se trouve en haut à droite sur le diagramme, c'est la partie "Client". Le code que nous voudrions utiliser se trouve à gauche, c'est le "Peer app process".</p><p>Si l'on résume la chose un peu grossièrement, la Peer API est plus proche de Datomic, puisque plus proche du serveur. Il est donc logique que cette API permette des manipulations plus sophistiquées. (Il faut savoir qu'initialement, il n'y avait pas de Client API dans Datomic. Tout se faisait au niveau du "Peer".)</p><h1 id="datomic-dev-local-vs-datomic-starter">Datomic dev-local vs Datomic Starter</h1><p>Pour rappel, lors du Meetup, je m'appuyais sur Datomic dev-local, qui est le moyen le plus simple de manipuler Datomic sans avoir à installer et lancer X process (cf Architecture). Malheureusement, cette solution ne fournit pas la Peer API (puisqu'il n'y a pas de Peer.</p><p>Il existe deux autres méthodes pour faire tourner (gratuitement) Datomic sur votre machine : Datomic Free et Datomic Starter. Je n'ai pas encore creusé la première, mais la seconde est un Datomic complet, sa seule limite étant que les mises à jour sont limitées à un an.</p><p>Pour l'expérience, je me suis lancé dans Datomic Starter. Après quelques modifications dans le code du Meetup, j'ai pu faire tourner ma requête "Log".</p><h1 id="différences-dapi">Différences d'API</h1><p>Pour faire fonctionner le code avec Datomic Starter, j'ai dû faire de grosses modifications dans le code. En effet, si les APIs sont très semblables, elles divergent sur des détails qui nous obligent à une ré-écriture. Par exemple, la fonction <code>d/transact</code>, qui nous sert à insérer les données, prend une map dans l'API Client et une list dans l'API Peer.</p><p>J'ai donc nettoyé le code pour séparer les manipulations simples (celles du Meetup) et la requête "Log" en utilisant d'une part l'API Client et d'autre part l'API Peer. Les deux pointant vers la même base Datomic. Notez que ceci doit être plus proche de l'usage réel de Datomic.</p><p>Tout le code est disponible dans le <a href="https://github.com/Charlynux/meetup-crafters-datalog">repository</a> du Meetup.</p><h1 id="to-be-continued">To Be Continued</h1><p>Afin d'approfondir ma compréhension de Datomic, il faudrait que je me plonge dans les talks de Rich Hickey, mais ils sont d'un certain niveau.</p><p>Pour l'instant, j'efforce de suivre la session "Day of Datomic" animée par Stuart Halloway (<a href="https://www.youtube.com/watch?v=yWdfhQ4_Yfw&amp;list=PLZdCLR02grLoMy4TXE4DZYIuxs3Q9uc4i&amp;ab_channel=ClojureTV">lien</a>).</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/clojure/">clojure</a>
    
    <a href="/tags-output/datomic/">datomic</a>
    
</div>


    <div id="prev-next">
        
        
        <a class="right" href="/posts-output/2020-11-29-repl-experiments-2/">REPL Experiments #2 &raquo;</a>
        
    </div>

    


</div>
</div>
        </div>

        <div class="col-md-3">
          <div id="sidebar">
            
            <div id="recent">
              <h3>Recent Posts</h3>
              <ul>
                
                <li><a href="/posts-output/2020-12-18-follow-the-rabbit-datomic/">Follow the white rabbit in Datomic</a></li>
                
                <li><a href="/posts-output/2020-11-29-repl-experiments-2/">REPL Experiments #2</a></li>
                
                <li><a href="/posts-output/2020-11-28-repl-experiments-first/">REPL Experiments #1</a></li>
                
              </ul>
            </div>
             
            <div id="tags">
              <h3>Tags</h3>
              <ul>
                
                <li><a href="/tags-output/clojure/">clojure</a></li>
                
                <li><a href="/tags-output/datomic/">datomic</a></li>
                
                <li><a href="/tags-output/java/">java</a></li>
                
                <li><a href="/tags-output/repl/">repl</a></li>
                
                <li><a href="/tags-output/jsf/">jsf</a></li>
                
              </ul>
            </div>
            
          </div>
        </div>
      </div>
      <footer>
        Copyright &copy; 2020 Charles Fourdrignier
        <p style="text-align: center">
          Powered by <a href="http://cryogenweb.org">Cryogen</a>
        </p>
      </footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="/js/highlight.pack.js" type="application/javascript"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
     
  </body>
</html>
